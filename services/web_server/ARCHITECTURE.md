# Web Server Architecture

This document explains how the `web_server` service works and how it connects to the frontend.

## Overview

The web server is a **FastAPI** application that provides the REST API for the Job Market Dashboard frontend.

```
┌─────────────────┐     GET /api/dashboard     ┌──────────────────┐
│                 │ ──────────────────────────▶│                  │
│  Frontend       │                            │  Web Server      │
│  (React)        │◀────────────────────────── │  (FastAPI)       │
│  localhost:5173 │      JSON Response         │  localhost:8080  │
└─────────────────┘                            └──────────────────┘
```

## Folder Structure

```
services/web_server/
├── src/
│   ├── main.py           # FastAPI app entry point
│   ├── routers/
│   │   └── dashboard.py  # API endpoints (/api/dashboard)
│   ├── db/
│   │   └── repository.py # Database queries (MySQL)
│   └── models/
│       └── *.py          # Pydantic data models
├── config/               # Configuration files
├── tests/                # Test files
└── pyproject.toml        # Python dependencies
```

## Key Files Explained

### 1. `src/main.py` - Application Entry Point

- Creates the FastAPI application
- Configures CORS middleware (allows frontend to call API)
- Includes the dashboard router
- Provides `/health` endpoint for health checks

```python
app = FastAPI(title="Job Market Dashboard API")
app.add_middleware(CORSMiddleware, allow_origins=["*"], ...)
app.include_router(dashboard_router)
```

### 2. `src/routers/dashboard.py` - API Endpoints

Provides the main API endpoint: `GET /api/dashboard`

**Current behavior**: Returns **mock data** generated by `generate_mock_data()`

**Future behavior**: Will query real data from MySQL using the repository

The mock data includes:

- 30-day job trend (job count and average salary per day)
- Top 10 skills by job count
- Regional distribution (台北市, 新北市, etc.)
- Industry distribution (軟體/網路, 半導體, etc.)
- Salary distribution (ranges like 30K-40K, 40K-50K, etc.)

### 3. `src/db/repository.py` - Database Repository

Contains SQL queries ready to fetch real data from MySQL:

| Method                      | Description                             |
| --------------------------- | --------------------------------------- |
| `get_job_count_by_date()`   | Job count & avg salary for last 30 days |
| `get_top_skills()`          | Top N skills by job count               |
| `get_jobs_by_region()`      | Job count per region                    |
| `get_jobs_by_industry()`    | Job count per industry                  |
| `get_salary_distribution()` | Jobs grouped by salary range            |
| `get_total_jobs()`          | Total job count                         |

> [!NOTE]
> The repository is **ready but not connected yet**. To enable real data,
> uncomment the TODO section in `dashboard.py` and configure database credentials.

### 4. `src/models/` - Data Models

Pydantic models that define the API response structure:

- `DashboardMeta` - Metadata (lastUpdated, totalJobs)
- `TimeSeriesPoint` - Trend data point (date, jobCount, avgSalary)
- `CategoryPoint` - Category data (label, value, percentage)
- `DashboardData` - Complete response combining all above

## Data Flow

```
┌───────────┐    ┌─────────┐    ┌──────────────┐    ┌─────────┐
│  Crawler  │───▶│  MySQL  │◀───│  Repository  │◀───│  Router │
│  Service  │    │   DB    │    │  (queries)   │    │  (API)  │
└───────────┘    └─────────┘    └──────────────┘    └────┬────┘
                                                         │
                      Currently bypassed with            │
                      mock data for development          │
                                                         ▼
                                                  ┌─────────────┐
                                                  │  Frontend   │
                                                  │  Dashboard  │
                                                  └─────────────┘
```

## Running the Server

```bash
cd services/web_server
uv run uvicorn src.main:app --port 8080 --reload
```

The `--reload` flag enables hot-reloading during development.

## API Reference

### `GET /api/dashboard`

Returns all dashboard data in a single response.

**Response Structure:**

```json
{
  "meta": {
    "lastUpdated": "2024-12-21T15:00:00",
    "totalJobs": 2500
  },
  "trend": [{ "date": "2024-12-21", "jobCount": 1200, "avgSalary": 55000 }],
  "skills": [{ "label": "Python", "value": 450 }],
  "regions": [{ "label": "台北市", "value": 1500, "percentage": 35.5 }],
  "industries": [{ "label": "軟體/網路", "value": 800, "percentage": 25.0 }],
  "salaryDist": [{ "label": "40K-50K", "value": 600, "percentage": 24.0 }]
}
```

### `GET /health`

Health check endpoint.

**Response:** `{ "status": "ok" }`

## Switching to Real Database

To connect to the real MySQL database:

1. Configure environment variables in `.env`:

   ```
   SQL_WEB_USER=your_username
   SQL_WEB_PASSWORD=your_password
   DB_HOST=localhost
   SQL_DATABASE=job_market
   ```

2. Update `dashboard.py` to use repository:

   ```python
   from src.db import DatabaseRepository

   @router.get("/api/dashboard")
   async def get_dashboard_data():
       repo = DatabaseRepository()
       # Build DashboardData from repo queries...
   ```

3. Ensure your crawler has populated the database tables:
   - `dim_job` - Job listings
   - `skills` - Skills extracted from jobs
   - `cust_info` - Company information
